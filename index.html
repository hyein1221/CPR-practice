<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>깨·알·누·사 생명 지킴이</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  :root{
    --navy:#101a3a; --text:#ffffff; --hint:#8fb3ff;
    --stage-w: 960px; --stage-h: 540px;
  }
  html,body{height:100%;margin:0;background:#0b0f1a;color:var(--text);font-family: "Press Start 2P", system-ui, sans-serif;}
  .wrap{display:flex;flex-direction:column;align-items:center;gap:10px;padding:14px;position:relative;}
  .topbar{width:var(--stage-w);background:var(--navy);color:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 6px 18px #0008;font-size:14px; text-align: center;}
  canvas{width:var(--stage-w);height:var(--stage-h);image-rendering: pixelated;display:block;border-radius:10px;box-shadow:0 10px 32px #000c;border:2px solid #1b274f;}
  .ui-overlay { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.85); border: 2px solid #fff; padding: 10px 20px; text-align: center; font-size: 16px; color: #fff; text-shadow: 1px 1px #000; display: none; border-radius: 5px; z-index: 10; width: 90%; max-width: 800px;}
  .big-message { font-size: 32px; top: 50%; bottom: auto; transform: translate(-50%, -50%); padding: 20px 30px; }
  footer{margin-top:12px;text-align:center;color:#6b7280;font-size:12px;}

  /* --- 가상 컨트롤러 스타일 --- */
  #virtual-controls {
    display: none; position: fixed; bottom: 0; left: 0;
    width: 100%; height: 150px; padding: 20px; box-sizing: border-box;
    justify-content: space-between; align-items: center;
    user-select: none; z-index: 100; pointer-events: none; /* 터치 이벤트만 받도록 */
  }
  #joystick-pad, #action-button-pad {
      pointer-events: auto; /* 버튼과 조이스틱은 터치 가능하도록 */
  }
  #joystick-pad { width: 120px; height: 120px; background: rgba(0,0,0,0.3); border-radius: 50%; position: relative; }
  #joystick-handle { width: 60px; height: 60px; background: rgba(0,0,0,0.5); border-radius: 50%; position: absolute; top: 30px; left: 30px; }
  #action-button-pad { display: flex; gap: 20px; }
  .v-btn {
    width: 70px; height: 70px; background: rgba(0,0,0,0.4); border-radius: 50%;
    display: flex; justify-content: center; align-items: center;
    font-family: "Press Start 2P"; font-size: 14px; color: #fff; border: 2px solid rgba(255,255,255,0.5);
  }
  #call-button {
    display: none; position: fixed;
    top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 200px; height: 80px; z-index: 101; font-size: 24px;
    background: #e53935; border-color: #fff; pointer-events: auto;
  }
  @media (pointer: coarse) {
    #virtual-controls { display: flex; }
  }
</style>
</head>
<body>
<div id="call-button" class="v-btn">CALL 119</div>

<div id="virtual-controls">
  <div id="joystick-pad">
    <div id="joystick-handle"></div>
  </div>
  <div id="action-button-pad">
    <div id="action-button-b" class="v-btn">Enter</div>
    <div id="action-button-a" class="v-btn">Space</div>
  </div>
</div>

<div class="wrap">
  <div id="top-bar" class="topbar">1단계: 깨우기- 길에서 쓰러진 사람 발견!</div>
  <canvas id="game-canvas" width="960" height="540"></canvas>
  <div id="instruction-box" class="ui-overlay"></div>
  <div id="big-message-box" class="ui-overlay big-message"></div>
  <footer>제작자: 질병관리청 국민소통단9기 김혜인 · 문의사항: <a href="mailto:hyein_1221@hanmail.net">hyein_1221@hanmail.net</a></footer>
</div>

<script>
  const canvas = document.getElementById('game-canvas');
  const ctx = canvas.getContext('2d');
  ctx.imageSmoothingEnabled = false;

  const topBar = document.getElementById('top-bar');
  const instructionBox = document.getElementById('instruction-box');
  const bigMessageBox = document.getElementById('big-message-box');

  let gameState = 'LOADING';
  const keys = {};

  const BASE_URL = 'https://raw.githubusercontent.com/hyein1221/CPR-practice/main/image/';
  const ASSET_PATHS = {
    background:   BASE_URL + 'background_park.png',
    player_idle:  BASE_URL + 'player_sprite_2.png',
    player_walk_1: BASE_URL + 'player_sprite_1.png',
    player_walk_2: BASE_URL + 'player_sprite_2.png',
    player_cpr:   BASE_URL + 'player_sprite_3.png',
    npc_fallen:   BASE_URL + 'npc_1.png',
    npc_walking:  BASE_URL + 'npc_sprite_2.png',
    exclamation:  BASE_URL + 'icon_exclamation.png',
    phone:        BASE_URL + 'icon_phone.png',
    aed_closed:   BASE_URL + 'aed_sprite_1.png',
    aed_open:     BASE_URL + 'aed_sprite_2.png',
    cprBar:       BASE_URL + 'ui_cpr_indicator.png',
    cprIndicator: BASE_URL + 'ui_cpr_bar.png'
  };
  const assets = {};
  
  function loadAssets() {
    let loadedCount = 0;
    const totalAssets = Object.keys(ASSET_PATHS).length;
    return Promise.all(
      Object.entries(ASSET_PATHS).map(([name, src]) => {
        return new Promise((resolve) => {
          const img = new Image();
          img.crossOrigin = "Anonymous";
          img.src = src;
          assets[name] = img;
          img.onload = () => {
            loadedCount++;
            ctx.fillStyle = '#000'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#fff'; ctx.font = "24px 'Press Start 2P'"; ctx.textAlign = 'center';
            ctx.fillText(`로딩 중... (${loadedCount}/${totalAssets})`, canvas.width / 2, canvas.height / 2);
            resolve();
          };
          img.onerror = () => {
            alert(`오류: ${src} 파일을 찾을 수 없습니다.`);
            resolve();
          };
        });
      })
    );
  }

  const PL = {
    w: 128, h: 128, x: 120, y: 260, speed: 4, facing: 1, state: 'idle',
    walkFrame: 0, walkTick: 0, walkSpeed: 8
  };
  const NPC = { w: 128, h: 128, x: 700, y: 280, state: 'fallen' };
  
  const exclamation = {
    x: NPC.x + NPC.w / 2 - 16, y: NPC.y - 60,
    w: 32, h: 48,
    visible: true, tick: 0, speed: 30
  };
  
  let cprProgress = 0;
  const CPR_TARGET_SUCCESS = 10;
  const cprBarUI = { x: canvas.width / 2 - 150, y: 100, width: 300, height: 60 };
  const cprIndicatorUI = { x: cprBarUI.x, y: 85, width: 20, height: 90, speed: 8, direction: 1 };
  const cprSweetSpot = { x: cprBarUI.x + cprBarUI.width * 0.4, width: cprBarUI.width * 0.2 };
  
  let phoneInput = "";
  const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

  function setupVirtualControls() {
    if (!isTouchDevice) return;

    const callButton = document.getElementById('call-button');
    const joystick = document.getElementById('joystick-handle');
    const joystickPad = document.getElementById('joystick-pad');
    const btnA = document.getElementById('action-button-a');
    const btnB = document.getElementById('action-button-b');
    let joystickActive = false;
    let startX;

    joystickPad.addEventListener('touchstart', (e) => { e.preventDefault(); joystickActive = true; startX = e.touches[0].clientX; }, { passive: false });
    joystickPad.addEventListener('touchmove', (e) => {
      e.preventDefault(); if (!joystickActive) return;
      const deltaX = e.touches[0].clientX - startX;
      const moveX = Math.max(-30, Math.min(30, deltaX));
      joystick.style.transform = `translateX(${moveX}px)`;
      keys['ArrowRight'] = deltaX > 15;
      keys['ArrowLeft'] = deltaX < -15;
    }, { passive: false });

    const endTouch = (e) => {
        e.preventDefault(); joystickActive = false; joystick.style.transform = 'none';
        keys['ArrowRight'] = false; keys['ArrowLeft'] = false;
    };
    joystickPad.addEventListener('touchend', endTouch);
    joystickPad.addEventListener('touchcancel', endTouch);

    btnA.addEventListener('touchstart', (e) => { e.preventDefault(); handleKeyPress({ code: 'Space', key: ' ' }); }, { passive: false });
    btnB.addEventListener('touchstart', (e) => { e.preventDefault(); handleKeyPress({ code: 'Enter', key: 'Enter' }); }, { passive: false });

    callButton.addEventListener('touchstart', (e) => {
      e.preventDefault();
      if (gameState === 'STAGE2_CALL') {
        phoneInput = '119';
        handleKeyPress({ key: '9' }); // 119가 완성되는 마지막 키 입력을 시뮬레이션
      }
    }, { passive: false });
  }

  window.addEventListener('keydown', e => { keys[e.code] = true; handleKeyPress(e); });
  window.addEventListener('keyup', e => { keys[e.code] = false; });

  function update() {
    if (gameState === 'STAGE1_DISCOVERY') {
      let isMoving = false;
      if (keys['ArrowRight']) { PL.x += PL.speed; PL.facing = 1; isMoving = true; }
      if (keys['ArrowLeft'])  { PL.x -= PL.speed; PL.facing = -1; isMoving = true; }
      PL.state = isMoving ? 'walk' : 'idle';
      PL.x = Math.max(0, Math.min(canvas.width - PL.w, PL.x));
      if (isMoving) {
        PL.walkTick++;
        if (PL.walkTick > PL.walkSpeed) {
          PL.walkTick = 0;
          PL.walkFrame = (PL.walkFrame + 1) % 2;
        }
      }
    }
    if (gameState === 'STAGE3_CPR') {
      cprIndicatorUI.x += cprIndicatorUI.speed * cprIndicatorUI.direction;
      if (cprIndicatorUI.x < cprBarUI.x || cprIndicatorUI.x + cprIndicatorUI.width > cprBarUI.x + cprBarUI.width) {
        cprIndicatorUI.direction *= -1;
      }
    }
    if (NPC.state === 'fallen' && gameState === 'STAGE1_DISCOVERY') {
        exclamation.tick++;
        if (exclamation.tick > exclamation.speed) {
            exclamation.tick = 0;
            exclamation.visible = !exclamation.visible;
        }
    }
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(assets.background, 0, 0, canvas.width, canvas.height);
    
    let playerImage;
    let playerX = PL.x, playerY = PL.y, playerW = PL.w, playerH = PL.h;

    let npcImage = (NPC.state === 'fallen') ? assets.npc_fallen : assets.npc_walking;
    let npcX = NPC.x, npcY = NPC.y, npcW = NPC.w, npcH = NPC.h;

    if (gameState === 'STAGE3_CPR' || gameState === 'STAGE4_AED' || gameState === 'SUCCESS') {
      npcImage = assets.npc_walking;
      npcX = 630; npcY = 300; npcW = 120; npcH = 100;
      playerImage = assets.player_cpr;
      playerX = npcX; playerY = npcY - 50;
    } else {
      playerImage = (PL.state === 'walk') ? (PL.walkFrame === 0 ? assets.player_walk_1 : assets.player_walk_2) : assets.player_idle;
    }
    
    drawSprite(playerImage, playerX, playerY, playerW, playerH, PL.facing === -1);
    ctx.drawImage(npcImage, npcX, npcY, npcW, npcH);

    if (NPC.state === 'fallen' && gameState === 'STAGE1_DISCOVERY') {
        if (exclamation.visible) {
            ctx.drawImage(assets.exclamation, exclamation.x, exclamation.y, exclamation.w, exclamation.h);
        }
    }
    if (gameState === 'STAGE2_CALL') {
        ctx.drawImage(assets.phone, canvas.width/2 - 200, canvas.height/2 - 200, 400, 400);
        if (!isTouchDevice) {
            ctx.font = "48px 'Press Start 2P'"; ctx.textAlign = 'center';
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 8;
            ctx.strokeText(phoneInput, canvas.width / 2, 200);
            ctx.fillStyle = '#000'; ctx.fillText(phoneInput, canvas.width / 2, 200);
        }
    }
    if (gameState === 'STAGE3_CPR') {
        ctx.drawImage(assets.cprBar, cprBarUI.x, cprBarUI.y, cprBarUI.width, cprBarUI.height);
        ctx.drawImage(assets.cprIndicator, cprIndicatorUI.x, cprIndicatorUI.y, cprIndicatorUI.width, cprIndicatorUI.height);
        ctx.font = "18px 'Press Start 2P'"; ctx.textAlign = 'center';
        ctx.strokeStyle = '#fff'; ctx.lineWidth = 4;
        ctx.strokeText(`압박 성공: ${cprProgress} / ${CPR_TARGET_SUCCESS}`, canvas.width / 2, cprBarUI.y + 85);
        ctx.fillStyle = '#000'; ctx.fillText(`압박 성공: ${cprProgress} / ${CPR_TARGET_SUCCESS}`, canvas.width / 2, cprBarUI.y + 85);
    }
    if (gameState === 'STAGE4_AED') {
        const aedImage = (cprProgress < 1) ? assets.aed_closed : assets.aed_open;
        ctx.drawImage(aedImage, canvas.width/2 - 125, canvas.height/2 - 150, 250, 300);
    }
  }
  
  function drawSprite(img, x, y, w, h, flip) {
    ctx.save();
    if (flip) { ctx.scale(-1, 1); ctx.drawImage(img, -x - w, y, w, h); }
    else { ctx.drawImage(img, x, y, w, h); }
    ctx.restore();
  }
  
  function handleKeyPress(e) {
    const key = e.key; const code = e.code;
    const callButton = document.getElementById('call-button');
    
    switch(gameState) {
      case 'STAGE1_DISCOVERY':
        if (code === 'Space' && Math.abs(PL.x - NPC.x) < 80) {
          gameState = 'STAGE2_CALL';
          topBar.textContent = "2단계: 알리기 - 119에 신고!";
          instructionBox.style.display = 'block';
          if (isTouchDevice) {
            instructionBox.textContent = "화면의 CALL 119 버튼을 누르세요!";
            callButton.style.display = 'flex';
          } else {
            instructionBox.textContent = "키보드 숫자 1, 1, 9를 차례로 누르세요!";
          }
        }
        break;
      case 'STAGE2_CALL':
        if (!isTouchDevice && !isNaN(key) && key.trim() !== '') {
          phoneInput += key;
        }
        if (phoneInput === '119') {
          gameState = 'STAGE3_CPR';
          topBar.textContent = "3단계: 누르기 - 가슴 압박 " + CPR_TARGET_SUCCESS + "회";
          instructionBox.textContent = isTouchDevice ? "화면 아무 곳이나 터치하여 압박!" : "막대가 파란 영역에 왔을 때 ↑ 키를 누르세요!";
          if (isTouchDevice) callButton.style.display = 'none';
        } else if (phoneInput.length >= 3) {
            phoneInput = "";
        }
        break;
      case 'STAGE3_CPR':
        // ✨ FIX: 터치 이벤트를 위해 canvas에 리스너 추가 (setupVirtualControls 밖으로)
        const cprKeyPressed = code === 'ArrowUp';
        if (cprKeyPressed) {
          const indicatorCenter = cprIndicatorUI.x + cprIndicatorUI.width / 2;
          const sweetSpotStart = cprSweetSpot.x;
          const sweetSpotEnd = cprSweetSpot.x + cprSweetSpot.width;
          if (indicatorCenter >= sweetSpotStart && indicatorCenter <= sweetSpotEnd) {
            cprProgress++;
            if (cprProgress >= CPR_TARGET_SUCCESS) {
              gameState = 'STAGE4_AED'; cprProgress = 0;
              topBar.textContent = '4단계: 사용하기 - AED 사용';
              instructionBox.textContent = isTouchDevice ? "A 버튼으로 AED 사용" : "Space를 눌러 AED를 사용하세요.";
            }
          }
        }
        break;
      case 'STAGE4_AED':
        if (code === 'Space') {
          cprProgress = 1;
          instructionBox.textContent = "Enter를 눌러 전기 충격을 가하세요.";
        } else if (code === 'Enter' && cprProgress === 1) {
            gameState = 'SUCCESS';
            topBar.textContent = '미션 성공! 생명을 구했습니다!';
            instructionBox.innerHTML = "Enter를 눌러 다시 시작";
            bigMessageBox.style.display = 'block';
            bigMessageBox.textContent = "미션 성공!";
        }
        break;
      case 'SUCCESS':
        if (code === 'Enter') window.location.reload();
        break;
    }
  }

  function gameLoop() {
    update();
    draw();
    requestAnimationFrame(gameLoop);
  }

  async function start() {
    setupVirtualControls();
    gameState = 'STAGE1_DISCOVERY';
    topBar.textContent = '1단계: 깨우기 - 환자에게 다가가기';
    instructionBox.style.display = 'block';
    instructionBox.innerHTML = "조작: <span class='kbd'>←</span> <span class='kbd'>→</span> 이동 · <span class='kbd'>Space</span> 상호작용";
    requestAnimationFrame(gameLoop);
    
    // ✨ FIX: 3단계 터치 이벤트를 위해 canvas에 리스너 추가
    if (isTouchDevice) {
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (gameState === 'STAGE3_CPR') {
                handleKeyPress({ code: 'ArrowUp' }); // 위쪽 화살표 키 입력을 시뮬레이션
            }
        }, { passive: false });
    }
  }

  loadAssets().then(start);
</script>
</body>
</html>
